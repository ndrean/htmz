events {
      worker_connections 4096;
      use epoll;  # Linux-specific, efficient event handling
  }

  http {
      # High-performance settings
      sendfile on;
      tcp_nopush on;
      tcp_nodelay on;
      keepalive_timeout 65;
      keepalive_requests 1000;

      # Disable access logs for load testing
      access_log off;
      error_log /dev/stderr warn;

      # Upstream pool
      upstream htmz_backend {
          server htmz:8080;
          keepalive 100;  # Keep 100 connections alive
      }

      server {
          listen 3000;

          # Disable buffering for faster proxying
          proxy_buffering off;
          proxy_request_buffering off;

          # Connection settings
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          proxy_set_header Host $host;

          # WebSocket endpoints
          location /ws {
              proxy_pass http://htmz_backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          # Dynamic endpoints - no cache
          location ~ ^/(cart-count|cart-total|api/.*) {
              proxy_pass http://htmz_backend;
              add_header Cache-Control "no-cache, no-store, must-revalidate";
          }

          # Static assets - cache
          location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico)$ {
              proxy_pass http://htmz_backend;
              add_header Cache-Control "public, max-age=3600";
          }

          # Everything else
          location / {
              proxy_pass http://htmz_backend;
              add_header Cache-Control "public, max-age=60";
          }
      }
  }