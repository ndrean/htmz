<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTMX-Z Demo</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Handlebars for client-side templates (fastest option) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js"></script>
    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-gray-50 min-h-screen flex flex-col items-center p-6 font-inter"
  >
    <header class="mb-8 text-center">
      <h1 class="text-5xl font-extrabold text-blue-600">My Shopping Cart</h1>
      <p class="text-md text-gray-500 mt-2">
        Frontend: <code>HTMX</code> & <code>TailwindCSS</code>
      </p>
      <p class="text-md text-gray-500 mt-1">
        Backend: <code>Zig</code>, <code>Zap</code>, <code>zig-sqlite</code>
      </p>
      <p class="text-md text-gray-500 mt-1">
        Authentication: <code>JWT</code>, Shopping Cart: stored in
        <code>HashMap</code>
      </p>
    </header>
    <main class="w-full max-w-6xl p-8 bg-white rounded-2xl shadow-xl">
      <!-- Navigation -->
      <nav
        class="flex justify-center mb-8 bg-gray-100 rounded-lg p-3 shadow-inner"
      >
        <a
          class="px-6 py-3 font-semibold text-blue-600 rounded-lg transition-colors duration-200 hover:bg-blue-100 mr-4"
          hx-get="/groceries"
          hx-target="#content"
          hx-push-url="true"
          hx-trigger="click"
          >Grocery List</a
        >
        <a
          class="px-6 py-3 font-semibold text-blue-600 rounded-lg transition-colors duration-200 hover:bg-blue-100"
          hx-get="/shopping-list"
          hx-target="#content"
          hx-push-url="true"
          hx-trigger="click"
          >Shopping List
          <span
            id="cart-badge"
            class="ml-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full"
            hx-get="/cart-count"
            hx-target="this"
            hx-swap="innerHTML"
            hx-trigger="load, updateCartCount from:body"
          >
            0
          </span></a
        >
      </nav>
      <!-- Main content area will be loaded here -->
      <div
        id="content"
        class="min-h-[500px] p-6 bg-gray-50 rounded-lg shadow-inner"
      >
        <!-- Default content loads on initial page load -->
        <div
          class="flex items-center justify-center h-full text-center text-gray-500"
        >
          <p class="text-2xl font-semibold">
            Select an option from the navigation menu to get started.
          </p>
        </div>
      </div>
    </main>
    <footer class="mt-8 text-gray-500 text-sm text-center">
      &copy; 2025 HTMX-Z
    </footer>

    <!-- Handlebars Templates for Client-Side Rendering (Updated from src/templates.zig) -->
    <script id="grocery-item-template" type="text/x-handlebars-template">
      <div class="bg-white rounded-lg p-4 shadow-md flex justify-between items-center transition-transform transform hover:scale-[1.02] cursor-pointer"
           onclick="loadItemDetails({{id}})">
        <div>
          <span class="text-lg font-semibold text-gray-900">{{name}}</span>
          <span class="text-sm text-gray-500 ml-2">${{price}}</span>
        </div>
        <button class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-full hover:bg-blue-600 transition-colors"
                onclick="addToCart({{id}}); event.stopPropagation()">
          Add to Cart
        </button>
      </div>
    </script>

    <script id="cart-item-template" type="text/x-handlebars-template">
      <div id="cart-item-{{id}}" class="flex justify-between items-center p-4 border-b">
        <div>
          <span class="font-semibold">{{name}}</span><br>
          <span class="text-sm text-gray-500">${{price}}</span>
        </div>
        <div class="flex items-center space-x-2">
          <button class="px-2 py-1 bg-red-500 text-white rounded"
                  onclick="updateQuantity({{id}}, -1)">-</button>
          <span id="qty-{{id}}" class="px-3 py-1 bg-gray-100 rounded">{{quantity}}</span>
          <button class="px-2 py-1 bg-green-500 text-white rounded"
                  onclick="updateQuantity({{id}}, 1)">+</button>
          <button class="px-2 py-1 bg-red-600 text-white rounded ml-2"
                  onclick="removeFromCart({{id}})">Remove</button>
        </div>
      </div>
    </script>

    <script id="item-details-template" type="text/x-handlebars-template">
      <div class="text-center">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">{{name}}</h3>
        <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center">
          <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
        </div>
        <div class="bg-blue-50 rounded-lg p-6 mb-6">
          <p class="text-3xl font-bold text-blue-600">${{price}}</p>
          <p class="text-gray-600 mt-2">per unit</p>
        </div>
        <button class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                onclick="addToCart({{id}})">
          Add to Cart
        </button>
      </div>
    </script>

    <!-- Client-Side JavaScript for Template Rendering -->
    <script>
      // Compile templates once on page load
      const groceryItemTemplate = Handlebars.compile(document.getElementById('grocery-item-template').innerHTML);
      const cartItemTemplate = Handlebars.compile(document.getElementById('cart-item-template').innerHTML);
      const itemDetailsTemplate = Handlebars.compile(document.getElementById('item-details-template').innerHTML);

      // Fast client-side functions
      async function loadGroceryItems() {
        try {
          const response = await fetch('/api/items/json');
          const items = await response.json();
          const html = items.map(groceryItemTemplate).join('');
          document.querySelector('[hx-get="/api/items"]').innerHTML = html;
        } catch (error) {
          console.error('Error loading grocery items:', error);
        }
      }

      async function loadCart() {
        try {
          const response = await fetch('/api/cart/json');
          const data = await response.json();

          if (data.items && data.items.length > 0) {
            const html = data.items.map(cartItemTemplate).join('');
            document.getElementById('cart-content').innerHTML = html;
          } else {
            document.getElementById('cart-content').innerHTML =
              '<p class="text-gray-600 text-center">Your cart is empty.</p>';
          }

          // Update cart total (matching the original behavior)
          updateCartTotal(data.total || 0);
          // Update badge count
          updateCartBadge(data.items ? data.items.reduce((sum, item) => sum + item.quantity, 0) : 0);

          // Trigger cartUpdate event to match original HTMX behavior
          triggerCartUpdate();
        } catch (error) {
          console.error('Error loading cart:', error);
        }
      }

      async function addToCart(itemId) {
        try {
          const response = await fetch(`/api/cart/add/${itemId}`, { method: 'POST' });
          if (response.ok) {
            loadCart(); // This will trigger cartUpdate
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
        }
      }

      async function updateQuantity(itemId, change) {
        const endpoint = change > 0 ? 'increase-quantity' : 'decrease-quantity';
        try {
          const response = await fetch(`/api/cart/${endpoint}/${itemId}`, { method: 'POST' });
          if (response.ok) {
            // For quantity updates, just update the specific quantity span and cart total
            const qtySpan = document.getElementById(`qty-${itemId}`);
            if (qtySpan) {
              const currentQty = parseInt(qtySpan.textContent);
              const newQty = currentQty + change;
              if (newQty <= 0) {
                // Remove the entire cart item if quantity becomes 0
                const cartItem = document.getElementById(`cart-item-${itemId}`);
                if (cartItem) cartItem.remove();
              } else {
                qtySpan.textContent = newQty;
              }
            }
            // Update totals
            loadCartTotals();
          }
        } catch (error) {
          console.error('Error updating quantity:', error);
        }
      }

      async function removeFromCart(itemId) {
        try {
          const response = await fetch(`/api/cart/remove/${itemId}`, { method: 'DELETE' });
          if (response.ok) {
            // Remove the cart item immediately from DOM
            const cartItem = document.getElementById(`cart-item-${itemId}`);
            if (cartItem) cartItem.remove();

            // Update totals
            loadCartTotals();
          }
        } catch (error) {
          console.error('Error removing from cart:', error);
        }
      }

      // Helper function to just update cart totals without full reload
      async function loadCartTotals() {
        try {
          const response = await fetch('/api/cart/json');
          const data = await response.json();
          updateCartTotal(data.total || 0);
          updateCartBadge(data.items ? data.items.reduce((sum, item) => sum + item.quantity, 0) : 0);
          triggerCartUpdate();
        } catch (error) {
          console.error('Error loading cart totals:', error);
        }
      }

      async function loadItemDetails(itemId) {
        try {
          const response = await fetch(`/api/item-details/${itemId}/json`);
          const item = await response.json();
          const html = itemDetailsTemplate(item);
          document.getElementById('item-details-card').innerHTML = html;
        } catch (error) {
          console.error('Error loading item details:', error);
        }
      }

      function updateCartBadge(count) {
        const badge = document.querySelector('[hx-get="/cart-count"]');
        if (badge) {
          badge.textContent = count;
        }
      }

      function updateCartTotal(total) {
        const cartTotal = document.getElementById('cart-total');
        if (cartTotal) {
          cartTotal.textContent = `$${total.toFixed(2)}`;
        }
      }

      function triggerCartUpdate() {
        // Trigger custom cartUpdate event to match original HTMX behavior
        const event = new CustomEvent('cartUpdate');
        document.body.dispatchEvent(event);
      }

      // Initialize templates and page loads when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        // Auto-load grocery items when groceries page is shown
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === 1) { // Element node
                // Check if groceries page was loaded
                const itemsContainer = node.querySelector('[hx-get="/api/items"]');
                if (itemsContainer) {
                  loadGroceryItems();
                }

                // Check if shopping list page was loaded
                const cartContainer = node.querySelector('#cart-content[hx-get="/api/cart"]');
                if (cartContainer) {
                  loadCart();
                }
              }
            });
          });
        });

        observer.observe(document.getElementById('content'), {
          childList: true,
          subtree: true
        });
      });
    </script>

  </body>
</html>
